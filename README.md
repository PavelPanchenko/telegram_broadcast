# Telegram Broadcast

Веб-приложение для массовой отправки постов в Telegram каналы с расширенным функционалом.

## Возможности

### Основные функции
- ✅ Массовая отправка постов в несколько каналов одновременно
- ✅ Поддержка изображений, видео и документов
- ✅ Множественные изображения в одном посте (галерея)
- ✅ Планирование постов на определенное время
- ✅ Автоматические повторяющиеся посты (ежедневно/еженедельно)
- ✅ История всех отправленных постов
- ✅ Шаблоны постов для быстрого создания
- ✅ Форматирование текста (HTML/MarkdownV2)
- ✅ Inline-кнопки под постами
- ✅ Автосохранение черновиков
- ✅ Группы каналов для быстрого выбора

### Управление каналами
- ✅ Добавление/удаление каналов
- ✅ Теги и категории для каналов
- ✅ Поиск и фильтрация каналов
- ✅ Экспорт/импорт списка каналов
- ✅ Проверка прав бота в каналах
- ✅ Автоматическая проверка прав администратора
- ✅ Отображение аватарок каналов

### Управление пользователями
- ✅ Система ролей (admin, user, assistant)
- ✅ Управление пользователями для админов
- ✅ Управление помощниками для пользователей
- ✅ Привязка ботов к пользователям
- ✅ Просмотр владельцев ботов и каналов (для админов)

### Технические особенности
- ✅ React Query для кеширования и управления состоянием
- ✅ Оптимизация изображений перед отправкой
- ✅ Retry механизм при ошибках
- ✅ Rate limiting для защиты API
- ✅ Логирование всех действий
- ✅ Адаптивный интерфейс
- ✅ Темная тема

## Установка

1. Установите зависимости:
```bash
npm install
```

2. Создайте файл `.env` в корне проекта:
```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
PORT=5001
SESSION_SECRET=your_random_secret_key_here
```

3. Получите токен бота:
   - Найдите [@BotFather](https://t.me/BotFather) в Telegram
   - Отправьте команду `/newbot`
   - Следуйте инструкциям для создания бота
   - Скопируйте полученный токен в файл `.env`

4. Добавьте бота администратором в каналы, куда хотите отправлять посты

## Запуск

### Разработка
```bash
npm run dev
```

Приложение будет доступно по адресу `http://localhost:3000`

### Продакшн
```bash
npm run build
npm run preview
```

## Использование

### Создание поста
1. Перейдите на вкладку "Создать пост"
2. Введите текст поста (поддерживается HTML/MarkdownV2 форматирование)
3. При необходимости добавьте файлы (изображения, видео, документы) - до 10 файлов
4. Добавьте кнопки под постом (опционально)
5. Выберите каналы для отправки (можно использовать поиск или группы каналов)
6. Запланируйте отправку или отправьте сразу

### Управление ботами
- Добавляйте несколько ботов для разных целей
- Каждый пользователь видит только своих ботов
- Админ видит все боты с информацией о владельцах
- Боты отображаются в горизонтальном скролле при большом количестве

### Управление каналами
1. Перейдите на вкладку "Каналы"
2. Добавьте канал: введите ID (@channel или -1001234567890) и название
3. Добавьте теги для группировки каналов
4. Используйте поиск и фильтры по тегам
5. Создавайте группы каналов для быстрого выбора
6. Экспортируйте или импортируйте список каналов

### Шаблоны
1. Перейдите на вкладку "Шаблоны"
2. Создайте шаблон с часто используемым текстом
3. Используйте шаблон при создании поста одним кликом

### Запланированные посты
1. При создании поста укажите дату и время отправки
2. Просматривайте все запланированные посты на соответствующей вкладке
3. Редактируйте или удаляйте запланированные посты

### Автоматические посты
1. Создайте автоматический пост с расписанием (ежедневно/еженедельно)
2. Управляйте включением/выключением автоматических постов
3. Просматривайте следующую дату отправки

### История
- Просматривайте историю всех отправленных постов
- Видите результаты отправки по каждому каналу
- Фильтруйте по количеству записей, дате, автору, тексту
- Очищайте старую историю

### Проверка прав
- Регулярно проверяйте права бота во всех каналах
- Получайте отчет о статусе прав в каждом канале

## Форматирование текста

### HTML
```html
<b>жирный</b>
<i>курсив</i>
<a href="https://example.com">ссылка</a>
<code>код</code>
```

### MarkdownV2
```markdown
*bold*
_italic_
[link](https://example.com)
`code`
```

## Технические детали

- **Максимальный размер файла**: 10 МБ
- **Максимум файлов**: 10 на пост
- **Поддерживаемые форматы изображений**: JPEG, PNG, GIF, WebP
- **Поддерживаемые форматы видео**: MP4, MOV
- **Поддерживаемые документы**: PDF, DOC, DOCX
- **Кеширование**: React Query с автоматической инвалидацией
- **Rate limiting**: защита от перегрузки API

## Структура данных

Все данные сохраняются в SQLite базе данных `server/database.db`:
- `users` - пользователи системы
- `tokens` - токены ботов
- `channels` - каналы для каждого бота (по tokenHash)
- `posts_history` - история постов
- `templates` - шаблоны постов
- `scheduled_posts` - запланированные посты
- `recurring_posts` - автоматические посты
- `channel_groups` - группы каналов
- `logs` - логи действий

### Миграция с JSON на SQLite

Если у вас есть старые данные в JSON файлах, выполните миграцию:

```bash
npm run migrate
```

Скрипт автоматически:
- Создаст БД и таблицы
- Перенесет все данные из JSON файлов
- Сохранит оригинальные JSON файлы (можно удалить после проверки)

**Важно:** После миграции приложение будет использовать только БД. JSON файлы больше не используются.

## Деплой

### Важно
Приложение состоит из двух частей:
- **Frontend** (React + Vite) - можно задеплоить на Vercel
- **Backend** (Express сервер) - требует постоянного процесса, лучше использовать Railway или Render

### Быстрый старт деплоя

#### Вариант 1: Полный деплой на Render (рекомендуется)
1. Зарегистрируйтесь на [Render](https://render.com)
2. Создайте новый Web Service
3. Подключите GitHub репозиторий
4. Render автоматически определит настройки из `render.yaml`
5. Добавьте переменные окружения в Dashboard
6. Готово! Render задеплоит и frontend, и backend

#### Вариант 2: Раздельный деплой
- **Frontend** → Vercel (см. инструкцию ниже)
- **Backend** → Railway или Render (см. инструкцию ниже)

#### Вариант 3: Развертывание на VPS через Docker Compose

Этот вариант позволяет развернуть приложение на собственном VPS сервере в контейнере Docker.

**Требования:**
- VPS сервер с установленными Docker и Docker Compose
- Минимум 1 ГБ RAM, 2 ГБ рекомендуется
- Минимум 10 ГБ свободного места на диске

**Шаги развертывания:**

1. **Подключитесь к вашему VPS:**
   ```bash
   ssh user@your-vps-ip
   ```

2. **Установите Docker и Docker Compose** (если еще не установлены):
   ```bash
   # Для Ubuntu/Debian
   curl -fsSL https://get.docker.com -o get-docker.sh
   sh get-docker.sh
   sudo usermod -aG docker $USER
   
   # Установка Docker Compose
   sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   ```

3. **Клонируйте репозиторий на сервер:**
   ```bash
   git clone <your-repo-url> telegram-broadcast
   cd telegram-broadcast
   ```

4. **Создайте файл `.env` в корне проекта:**
   ```bash
   nano .env
   ```
   
   Добавьте следующие переменные:
   ```env
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   SESSION_SECRET=your_random_secret_key_here
   # Для HTTP (без HTTPS) установите false, для HTTPS - true
   COOKIE_SECURE=false
   ```

5. **Создайте необходимые директории и установите права доступа:**
   ```bash
   mkdir -p server/data uploads
   # Установите права доступа (важно для работы БД в Docker)
   chmod -R 755 server/data uploads
   # Убедитесь, что директории принадлежат текущему пользователю
   sudo chown -R $USER:$USER server/data uploads
   ```
   
   **Важно:** Если вы используете Docker, убедитесь, что директории существуют на хосте перед запуском контейнера, иначе могут возникнуть проблемы с правами доступа к БД.

6. **Запустите приложение через Docker Compose:**
   ```bash
   docker-compose up -d --build
   ```

7. **Проверьте статус контейнера:**
   ```bash
   docker-compose ps
   docker-compose logs -f
   ```

8. **Настройте Nginx (опционально, для использования домена):**
   
   Установите Nginx:
   ```bash
   sudo apt update
   sudo apt install nginx
   ```
   
   Создайте конфигурацию:
   ```bash
   sudo nano /etc/nginx/sites-available/telegram-broadcast
   ```
   
   Добавьте конфигурацию:
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
   
       location / {
           proxy_pass http://localhost:5001;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```
   
   Активируйте конфигурацию:
   ```bash
   sudo ln -s /etc/nginx/sites-available/telegram-broadcast /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

9. **Настройте SSL сертификат (опционально, через Let's Encrypt):**
   ```bash
   sudo apt install certbot python3-certbot-nginx
   sudo certbot --nginx -d your-domain.com
   ```

**Управление контейнером:**

- **Остановить:** `docker-compose down`
- **Перезапустить:** `docker-compose restart`
- **Обновить приложение:**
  ```bash
  git pull
  docker-compose up -d --build
  ```
- **Просмотр логов:** `docker-compose logs -f`
- **Очистка старых образов:** `docker system prune -a`

**Важные замечания:**

- Данные сохраняются в `./server/data` и `./uploads` на хосте благодаря volume монтированию
- При обновлении приложения данные не теряются
- Убедитесь, что порт 5001 открыт в firewall:
  ```bash
  sudo ufw allow 5001/tcp
  ```
- Для продакшн использования рекомендуется настроить автоматические бэкапы директории `server/data`

### Деплой Frontend на Vercel

1. **Подготовка проекта:**
   ```bash
   # Убедитесь, что проект собран
   npm run build
   ```

2. **Создайте файл `vercel.json` в корне проекта:**
   ```json
   {
     "buildCommand": "npm run build",
     "outputDirectory": "dist",
     "devCommand": "npm run dev:client",
     "installCommand": "npm install",
     "framework": "vite",
     "rewrites": [
       {
         "source": "/api/(.*)",
         "destination": "https://your-backend-url.com/api/$1"
       },
       {
         "source": "/(.*)",
         "destination": "/index.html"
       }
     ]
   }
   ```

3. **Установите Vercel CLI:**
   ```bash
   npm i -g vercel
   ```

4. **Деплой:**
   ```bash
   vercel
   ```

5. **Настройте переменные окружения в Vercel Dashboard:**
   - Перейдите в Settings → Environment Variables
   - Добавьте переменные (если нужны для build)

### Деплой Backend на Railway/Render

#### Railway

1. Создайте аккаунт на [Railway](https://railway.app)
2. Создайте новый проект
3. Подключите GitHub репозиторий
4. Railway автоматически определит Node.js проект
5. Добавьте переменные окружения:
   - `TELEGRAM_BOT_TOKEN`
   - `PORT` (Railway установит автоматически)
   - `SESSION_SECRET`
6. Railway автоматически задеплоит проект

#### Render

1. Создайте аккаунт на [Render](https://render.com)
2. Создайте новый Web Service
3. Подключите GitHub репозиторий
4. Настройки:
   - **Build Command**: `npm install`
   - **Start Command**: `node server/index.js`
   - **Environment**: Node
5. Добавьте переменные окружения в разделе Environment
6. Нажмите "Create Web Service"

### Альтернатива: Полный деплой на Render

Render поддерживает полноценные Node.js приложения:

1. Создайте Web Service на Render
2. Настройки:
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `node server/index.js`
3. Добавьте переменные окружения
4. Render автоматически задеплоит приложение

### Настройка после деплоя

1. **Обновите CORS настройки** в `server/index.js` для вашего frontend домена
2. **Обновите `vercel.json`** с правильным URL backend
3. **Настройте сессии** - используйте внешнее хранилище (Redis) для продакшн
4. **Настройте файловое хранилище** - используйте S3 или подобное для `uploads/`

### Переменные окружения для продакшн

```env
TELEGRAM_BOT_TOKEN=your_bot_token
PORT=5001
SESSION_SECRET=your_strong_random_secret
NODE_ENV=production
CORS_ORIGIN=https://your-frontend.vercel.app
```

## Безопасность

- Rate limiting: максимум 100 запросов за 15 минут
- Валидация файлов на сервере
- Система аутентификации с сессиями
- Проверка прав бота перед добавлением канала
- Изоляция данных между пользователями

## Примечания

- Бот должен быть администратором всех каналов, куда вы хотите отправлять посты
- Изображения автоматически оптимизируются перед отправкой
- При ошибках отправка повторяется до 3 раз
- Черновики автоматически сохраняются в браузере
- React Query кеширует данные для уменьшения запросов к API

## Технологии

- **Frontend**: React 18, Vite, Tailwind CSS, React Query
- **Backend**: Node.js, Express
- **Telegram API**: node-telegram-bot-api
- **Обработка изображений**: Sharp
- **Планировщик**: node-cron

## Лицензия

MIT
